<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Inline Video Queue</title>

<style>
:root{
  --bg:#0f1724;
  --card:#0b1220;
  --muted:#9aa6b2;
  --accent:#06b6d4;
  --soft:#e6eef5;
}
*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
  background:linear-gradient(180deg,#071025 0%, #071827 100%);
  color:var(--soft);
  font-family:Arial, Helvetica, sans-serif;
}
body{
  padding:16px;
  overflow-x:hidden;
}

/* Queue Container */
.queue{
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow-y:auto;
  max-height:100vh;
}

/* Item Card */
.queue-item{
  background:rgba(255,255,255,0.05);
  border-radius:10px;
  padding:10px;
  cursor:pointer;
  transition:0.15s, opacity 0.3s ease-in;
  opacity:0;
}
.queue-item.visible{opacity:1;}
.queue-item.active{
  border:1px solid var(--accent);
  box-shadow:0 6px 20px rgba(6,182,212,0.3);
}

/* Thumbnail */
.thumb{
  width:100%;
  aspect-ratio:16/9;
  border-radius:8px;
  background:#000;
  overflow:hidden;
  background-size:cover;
  background-position:center;
}

/* Metadata */
.q-title{font-size:15px;font-weight:600;margin:6px 0 2px}
.q-sub{font-size:12px;color:var(--muted)}
.q-id{font-size:11px;color:var(--muted)}
.q-link{font-size:12px;color:var(--soft); margin-top:4px}
.q-link a{color:#4ecbff;text-decoration:none;}
.q-link a:hover{text-decoration:underline;}

/* Controls */
.controls{
  display:flex;
  justify-content:center;
  gap:12px;
  padding:14px 0;
  position:sticky;
  bottom:10px;
}
.btn{
  padding:8px 14px;
  border-radius:8px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.2);
  color:var(--soft);
  cursor:pointer;
  font-size:14px;
}
.btn:hover{
  background:var(--accent);
  color:#000;
}

/* Primary/Secondary variations (used inside modal) */
.btn.primary{
  background:var(--accent);
  color:#000;
  border-color:var(--accent);
}
.btn.secondary{
  background:rgba(255,255,255,0.08);
  color:var(--soft);
}

/* Loader */
.loader{
  text-align:center;
  padding:20px;
  color:var(--muted);
  font-size:14px;
}

/* ----------- MODAL OVERLAY ----------- */
.ad-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
.ad-overlay.hidden{display:none;}
.ad-modal{
  background:var(--card);
  padding:20px;
  border-radius:12px;
  max-width:90%;
  width:340px;
  text-align:center;
  color:var(--soft);
}
.ad-modal h2{
  margin:0 0 12px;
  font-size:20px;
}
.ad-modal p{
  margin:8px 0;
}
.ad-buttons{
  display:flex;
  justify-content:space-around;
  margin-top:15px;
}
.countdown-timer{
  font-size:32px;
  margin:8px 0;
}
</style>
</head>

<body>

<div class="queue" id="queueList">
  <div class="loader" id="loader">Loading videos...</div>
</div>

<div class="controls">
  <button class="btn" id="prevBtn">Prev</button>
  <button class="btn" id="nextBtn">Next</button>
</div>

<!-- ==================== MODAL (added by script) ==================== -->

<script>
/* -------------------------------------------------
   Constants & Global variables
------------------------------------------------- */
const BACKEND = 'https://free_videos_displaying_backend.ajaia-backend.workers.dev';
const STORAGE_KEY = 'clicked_ids';
const AD_CHECKPOINTS = [10,120,300,600,1200,1800,2400,3000,3600,4200,4800,5400,6000,6600,7200];

const queueList = document.getElementById('queueList');
const loader    = document.getElementById('loader');

let videos = [];               // all videos received from backend
let displayedCount = 0;        // how many items already rendered
const BATCH_SIZE = 30;         // batch size for infinite scroll
let currentIndex = 0;          // index of video currently playing

let activeVideo = null;        // video element that is currently active/inâ€‘gate

/* -------------------------------------------------
   ---------- LocalStorage helpers ----------
------------------------------------------------- */
function getStoredIds(){
  try{
    const stored = localStorage.getItem(STORAGE_KEY);
    return stored ? JSON.parse(stored) : [];
  }catch{ return []; }
}
function store(id){
  const ids = new Set(getStoredIds());
  ids.add(Number(id));
  localStorage.setItem(STORAGE_KEY, JSON.stringify([...ids]));
}
function clearStored(){ localStorage.removeItem(STORAGE_KEY); }

/* -------------------------------------------------
   ---------- Send stored clicks to backend ----------
------------------------------------------------- */
async function sendStoredToBackend(){
  const ids = getStoredIds();
  if(ids.length===0) return;
  try{
    await fetch(`${BACKEND}/clicked_videos`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({video_ids:ids})
    });
    console.log('Sent to backend:',ids);
    clearStored();
  }catch(err){
    console.error('Failed to send ids:',err);
  }
}

/* -------------------------------------------------
   ---------- Load all videos once ----------
------------------------------------------------- */
async function loadVideos(){
  loader.textContent = "Fetching videos...";
  try{
    const res = await fetch(BACKEND);
    videos = await res.json();
    loader.remove();
    renderNextBatch();
  }catch{
    loader.textContent = "âŒ Failed to load videos from backend";
  }
}

/* -------------------------------------------------
   ---------- Render next batch ----------
------------------------------------------------- */
function renderNextBatch(){
  const nextBatch = videos.slice(displayedCount, displayedCount + BATCH_SIZE);
  displayedCount += nextBatch.length;

  nextBatch.forEach((v,i)=>{
    const card = document.createElement('div');
    card.className = 'queue-item';
    const absoluteIndex = (displayedCount - nextBatch.length) + i;

    card.innerHTML = `
      <div class="thumb" style="background-image:url('${v.archive_org_iframe_image_link||""}')"></div>
      <div class="q-title">${v.title || "Untitled"}</div>
      <div class="q-sub">By ${v.username || "Unknown"}</div>
      <div class="q-id">ID: ${v.id || "?"}</div>

      <div class="q-link">Link 1: <a href="${v.link_1}" target="_blank">${v.link_1 || "No link"}</a></div>
      <div class="q-link">Link 2: <a href="${v.link_2}" target="_blank">${v.link_2 || "No link"}</a></div>
    `;
    card.onclick = () => playInline(absoluteIndex);
    queueList.appendChild(card);
    requestAnimationFrame(()=>card.classList.add('visible'));
  });

  if(displayedCount >= videos.length){
    const endMsg = document.createElement('div');
    endMsg.className = 'loader';
    endMsg.textContent = "ðŸŽ‰ All videos loaded";
    queueList.appendChild(endMsg);
  }
}

/* -------------------------------------------------
   ---------- Infiniteâ€‘scroll ----------
------------------------------------------------- */
queueList.addEventListener('scroll',()=>{
  const bottomReached = queueList.scrollTop + queueList.clientHeight >= queueList.scrollHeight - 150;
  if(bottomReached && displayedCount < videos.length){
    renderNextBatch();
  }
});

/* -------------------------------------------------
   ---------- Helpers ----------
------------------------------------------------- */
function hasAndroidBridge(){
  return (typeof Android !== 'undefined' && Android !== null);
}
function shouldShowAds(videoData){
  return videoData.phone_number != null && videoData.phone_number !== '' && videoData.phone_number !== 'NULL';
}

/* -------------------------------------------------
   ---------- Native callbacks ----------
------------------------------------------------- */
window.onAdPreloaded = function(){
  console.log('onAdPreloaded()');
};
window.onAdFailedToPreload = function(){
  console.warn('onAdFailedToPreload()');
};
window.onAdNotAvailable = function(){
  console.warn('onAdNotAvailable() â€“ resuming video (no ad).');
  if(activeVideo){
    activeVideo._gateOpen = false;
    if(activeVideo._wasPausedForAd){
      activeVideo._wasPausedForAd = false;
      activeVideo.play().catch(()=>{});
    }
  }
};
window.onAdCompleted = function(targetUrl){
  console.log('onAdCompleted() ->',targetUrl);
  // 1â€‘second reward toast
  showRewardToast();

  // Resume the video that was paused for the ad
  if(activeVideo){
    activeVideo._gateOpen = false;
    if(activeVideo._wasPausedForAd){
      activeVideo._wasPausedForAd = false;
      activeVideo.play().catch(()=>{});
    }
  }
  // Hide modal (in case it is still visible)
  if(!adOverlay.classList.contains('hidden')){
    adOverlay.classList.add('hidden');
  }

  // Preâ€‘load the next ad
  try{
    if(hasAndroidBridge()){
      if(typeof Android.preloadRewardedAd === 'function'){
        Android.preloadRewardedAd();
      }else if(Android.preloadRewardedAd){
        Android.preloadRewardedAd();
      }
    }
  }catch(e){ console.warn('preload after ad error',e); }

  // Open optional target URL
  if(targetUrl && targetUrl !== 'null' && targetUrl !== ''){
    try{
      if(hasAndroidBridge()){
        if(typeof Android.loadUrlInWebView === 'function'){
          Android.loadUrlInWebView(targetUrl);
        }else if(Android.loadUrlInWebView){
          Android.loadUrlInWebView(targetUrl);
        }else{
          window.location.href = targetUrl;
        }
      }else{
        window.location.href = targetUrl;
      }
    }catch(e){ console.error('failed to open targetUrl',e); }
  }
};

/* -------------------------------------------------
   ---------- Modal (Continue Watching) ----------
------------------------------------------------- */
const adOverlay = document.createElement('div');
adOverlay.id = 'adOverlay';
adOverlay.className = 'ad-overlay hidden';
adOverlay.innerHTML = `
  <div class="ad-modal">
    <h2 id="adTitle">Continue Watching</h2>
    <p id="adMessage">
      To continue watching this video, please watch a short advertisement.<br>
      This helps us support the service and keep the content available.
    </p>

    <div id="countdownContainer" style="display:none;">
      <p>Please wait</p>
      <p id="countdownMessage">
        The video is currently paused. You can continue watching after the countdown finishes.
      </p>
      <div class="countdown-timer" id="timerDisplay">45</div>
      <button class="btn primary" id="watchAdDuringCountdownBtn">Watch Ad</button>
    </div>

    <div class="ad-buttons">
      <button class="btn primary" id="watchAdBtn">Watch Ad</button>
      <button class="btn secondary" id="cancelBtn">Cancel</button>
    </div>
  </div>`;
document.body.appendChild(adOverlay);

const watchAdBtn               = document.getElementById('watchAdBtn');
const cancelBtn               = document.getElementById('cancelBtn');
const watchAdDuringCountdownBtn = document.getElementById('watchAdDuringCountdownBtn');
const countdownContainer      = document.getElementById('countdownContainer');
const timerDisplay            = document.getElementById('timerDisplay');

let countdownInterval = null;
let countdownRemaining = 45;

/* -------------------------------------------------
   ---------- Helper: exit fullscreen ----------
------------------------------------------------- */
function exitFullScreen(){
  if (document.fullscreenElement){
    document.exitFullscreen().catch(()=>{});
  }else if (document.webkitFullscreenElement){
    document.webkitExitFullscreen && document.webkitExitFullscreen();
  }else if (document.mozFullScreenElement){
    document.mozCancelFullScreen && document.mozCancelFullScreen();
  }else if (document.msFullscreenElement){
    document.msExitFullscreen && document.msExitFullscreen();
  }
}

/* -------------------------------------------------
   ---------- Show modal (gate) ----------
------------------------------------------------- */
function showGate(video){
  video._gateOpen = true;
  activeVideo = video;
  // pause video immediately
  try{ video.pause(); }catch(e){}
  // leave fullscreen so that the modal is fully visible
  exitFullScreen();

  // reset UI to the default (watch / cancel)
  document.getElementById('watchAdBtn').style.display   = 'inline-block';
  document.getElementById('cancelBtn').style.display    = 'inline-block';
  countdownContainer.style.display = 'none';
  adOverlay.classList.remove('hidden');
}

/* -------------------------------------------------
   ---------- Countdown after Cancel ----------
------------------------------------------------- */
function startCountdown(){
  // hide primary/secondary buttons
  document.getElementById('watchAdBtn').style.display = 'none';
  document.getElementById('cancelBtn').style.display  = 'none';
  // show countdown UI
  countdownContainer.style.display = 'block';
  countdownRemaining = 45;
  timerDisplay.textContent = countdownRemaining;

  countdownInterval = setInterval(()=>{
    countdownRemaining--;
    if(countdownRemaining <= 0){
      clearInterval(countdownInterval);
      countdownInterval = null;
      // countdown finished -> resume playback
      hideGateAndResume();
    }else{
      timerDisplay.textContent = countdownRemaining;
    }
  },1000);
}

/* -------------------------------------------------
   ---------- Hide modal & resume video ----------
------------------------------------------------- */
function hideGateAndResume(){
  adOverlay.classList.add('hidden');
  if(activeVideo){
    activeVideo._gateOpen = false;
    activeVideo.play().catch(()=>{});
  }
  activeVideo = null;
  if(countdownInterval){
    clearInterval(countdownInterval);
    countdownInterval = null;
  }
}

/* -------------------------------------------------
   ---------- Request native rewarded ad ----------
------------------------------------------------- */
function requestRewardedAd(){
  try{
    if(hasAndroidBridge()){
      if(typeof Android.requestRewardedAd === 'function'){
        Android.requestRewardedAd(activeVideo ? (activeVideo.currentSrc || activeVideo.src) : '');
      }else if (Android.requestRewardedAd){
        Android.requestRewardedAd(activeVideo ? (activeVideo.currentSrc || activeVideo.src) : '');
      }
    }else{
      // -------------------------------------------------
      // Simulate ad flow when running in a normal browser
      // -------------------------------------------------
      console.warn('Android bridge not detected â€“ simulating ad.');
      setTimeout(()=>{ window.onAdCompleted(null); },1500);
    }
  }catch(e){
    console.error('requestRewardedAd error',e);
    // Ensure video can continue even if the native call failed
    if(activeVideo){
      activeVideo._gateOpen = false;
      activeVideo.play().catch(()=>{});
    }
  }
}

/* -------------------------------------------------
   ---------- Toast (1â€‘second reward) ----------
------------------------------------------------- */
function showRewardToast(){
  const toast = document.createElement('div');
  toast.textContent = 'Reward granted!';
  toast.style.position = 'fixed';
  toast.style.bottom = '20px';
  toast.style.right = '20px';
  toast.style.background = 'rgba(0,0,0,0.8)';
  toast.style.color = '#fff';
  toast.style.padding = '8px 12px';
  toast.style.borderRadius = '5px';
  toast.style.zIndex = '10000';
  document.body.appendChild(toast);
  setTimeout(()=>{ toast.remove(); },1000);
}

/* -------------------------------------------------
   ---------- Modal button listeners ----------
------------------------------------------------- */
watchAdBtn.addEventListener('click',()=>{
  // User agreed to watch the ad
  adOverlay.classList.add('hidden');
  if(activeVideo) activeVideo._wasPausedForAd = true;
  requestRewardedAd();
});

cancelBtn.addEventListener('click',()=>{
  // User cancelled â€“ start the 45â€‘second wait
  startCountdown();
});

watchAdDuringCountdownBtn.addEventListener('click',()=>{
  // User wants to watch an ad while the countdown is running
  if(countdownInterval){
    clearInterval(countdownInterval);
    countdownInterval = null;
  }
  adOverlay.classList.add('hidden');
  if(activeVideo) activeVideo._wasPausedForAd = true;
  requestRewardedAd();
});

/* -------------------------------------------------
   ---------- Play inline video (with checkpoints) ----------
------------------------------------------------- */
function playInline(i){
  currentIndex = i;
  const v = videos[i];
  const items = document.querySelectorAll('.queue-item');

  items.forEach((el,idx)=>{
    const isActive = idx===i;
    el.classList.toggle('active', isActive);
    const thumb = el.querySelector('.thumb');

    if(isActive){
      thumb.innerHTML = `
        <video controls controlsList="nodownload" autoplay playsinline
               style="width:100%;height:100%"
               src="${v.mp4_link}"
               poster="${v.archive_org_iframe_image_link}"></video>`;
    }else{
      thumb.innerHTML = '';
      if(videos[idx]) thumb.style.backgroundImage = `url('${videos[idx].archive_org_iframe_image_link}')`;
    }
  });

  // scroll the selected item into view
  queueList.children[i]?.scrollIntoView({behavior:'smooth',block:'center'});

  // record click for backend
  if(v.id!=null) store(Number(v.id));

  requestAnimationFrame(()=>{
    const active = document.querySelector('.queue-item.active');
    if(!active) return;
    const video = active.querySelector('video');
    if(!video) return;

    // initialise perâ€‘video state
    video._triggeredCheckpoints = new Set();
    video._gateOpen = false;
    video._wasPausedForAd = false;

    const adsEnabled = shouldShowAds(v);

    // detach any previous listener
    if(video._timeupdateListener){
      video.removeEventListener('timeupdate',video._timeupdateListener);
    }

    function onTimeUpdate(){
      if(video._gateOpen) return;                 // a modal is already shown
      if(!adsEnabled) return;                    // no ads for this video

      for(const checkpoint of AD_CHECKPOINTS){
        if(video.currentTime >= checkpoint && !video._triggeredCheckpoints.has(checkpoint)){
          video._triggeredCheckpoints.add(checkpoint);
          // Show the â€œContinue Watchingâ€ dialog
          showGate(video);
          break; // only one checkpoint at a time
        }
      }
    }
    video._timeupdateListener = onTimeUpdate;
    video.addEventListener('timeupdate',video._timeupdateListener);
  });
}

/* -------------------------------------------------
   ---------- Prev / Next ----------
------------------------------------------------- */
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

prevBtn.onclick = () => {
  if(videos.length>0) playInline((currentIndex-1+videos.length)%videos.length);
};
nextBtn.onclick = () => {
  if(videos.length>0) playInline((currentIndex+1)%videos.length);
};

/* -------------------------------------------------
   ---------- Init ----------
------------------------------------------------- */
(async()=>{
  await sendStoredToBackend();
  await loadVideos();

  // ask native to preload a rewarded ad as soon as the app starts
  try{
    if(hasAndroidBridge()){
      if(typeof Android.preloadRewardedAd === 'function'){
        Android.preloadRewardedAd();
      }else if (Android.preloadRewardedAd){
        Android.preloadRewardedAd();
      }
      console.log('Requested native preload of rewarded ad.');
    }else{
      console.log('Android bridge not detected â€“ running in browser.');
    }
  }catch(e){
    console.warn('preload request failed',e);
  }
})();
</script>

</body>
</html>
