<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Inline Video Queue</title>
<style>
:root{
  --bg:#0f1724;
  --card:#0b1220;
  --muted:#9aa6b2;
  --accent:#06b6d4;
  --soft:#e6eef5;
}
*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
  background:linear-gradient(180deg,#071025 0%, #071827 100%);
  color:var(--soft);
  font-family:Arial, Helvetica, sans-serif;
}
body{
  padding:16px;
  overflow-x:hidden;
}

/* Queue */
.queue{
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow-y:auto;
  max-height:100vh;
}
.queue-item{
  background:rgba(255,255,255,0.05);
  border-radius:10px;
  padding:10px;
  cursor:pointer;
  transition:0.15s,opacity .3s ease-in;
  opacity:0;
}
.queue-item.visible{opacity:1;}
.queue-item.active{
  border:1px solid var(--accent);
  box-shadow:0 6px 20px rgba(6,182,212,.3);
}
.thumb{
  width:100%;
  aspect-ratio:16/9;
  border-radius:8px;
  background:#000;
  overflow:hidden;
  background-size:cover;
  background-position:center;
}
.q-title{font-size:15px;font-weight:600;margin:6px 0 2px}
.q-sub{font-size:12px;color:var(--muted)}
.q-id{font-size:11px;color:var(--muted)}
.q-link{font-size:12px;color:var(--soft);margin-top:4px}
.q-link a{color:#4ecbff;text-decoration:none}
.q-link a:hover{text-decoration:underline}

/* Controls */
.controls{
  display:flex;
  justify-content:center;
  gap:12px;
  padding:14px 0;
  position:sticky;
  bottom:10px;
}
.btn{
  padding:8px 14px;
  border-radius:8px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.2);
  color:var(--soft);
  cursor:pointer;
  font-size:14px;
}
.btn:hover{
  background:var(--accent);
  color:#000;
}

/* Loader */
.loader{
  text-align:center;
  padding:20px;
  color:var(--muted);
  font-size:14px;
}

/* ---------- Modal (ad prompt) ---------- */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.modal.hidden{display:none}
.modal-content{
  background:var(--card);
  padding:20px;
  border-radius:10px;
  max-width:300px;
  width:90%;
  text-align:center;
  color:var(--soft);
}
.modal-content .btn{
  width:100%;
  margin:8px 0;
}
#countdownContainer{margin-top:12px}
</style>
</head>

<body>

<div class="queue" id="queueList">
  <div class="loader" id="loader">Loading videos...</div>
</div>

<div class="controls">
  <button class="btn" id="prevBtn">Prev</button>
  <button class="btn" id="nextBtn">Next</button>
</div>

<!-- ---------- Rewardâ€‘ad Prompt Modal ---------- -->
<div id="adModal" class="modal hidden">
  <div class="modal-content">
    <p>Ad point reached. Choose an option.</p>
    <button id="modalWatchBtn" class="btn primary">Watch Ad</button>
    <button id="modalWaitBtn" class="btn">Wait 45 seconds</button>
    <div id="countdownContainer" class="hidden">
      <p class="small">Resuming in <span id="countdownNumber">45</span> seconds.</p>
    </div>
  </div>
</div>

<script>
/* -------------------------------------------------------------------------
 *  Constants & small helpers
 * ----------------------------------------------------------------------- */
const BACKEND = 'https://free_videos_displaying_backend.ajaia-backend.workers.dev';
const STORAGE_KEY = 'clicked_ids';
const AD_CHECKPOINTS = [10,120,300,600,1200,1800,2400,3000,3600,4200,4800,5400,6000,6600,7200];

/* -------------------------------------------------------------------------
 *  LocalStorage helpers
 * ----------------------------------------------------------------------- */
function getStoredIds(){
  try{
    const s = localStorage.getItem(STORAGE_KEY);
    return s ? JSON.parse(s) : [];
  }catch{ return []; }
}
function store(id){
  const ids = new Set(getStoredIds());
  ids.add(id);
  localStorage.setItem(STORAGE_KEY,JSON.stringify([...ids]));
}
function clearStored(){ localStorage.removeItem(STORAGE_KEY); }

/* -------------------------------------------------------------------------
 *  Send stored clicks to backend
 * ----------------------------------------------------------------------- */
async function sendStoredToBackend(){
  const ids = getStoredIds();
  if(!ids.length) return;
  try{
    await fetch(`${BACKEND}/clicked_videos`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({video_ids:ids})
    });
    console.log('Sent to backend:',ids);
    clearStored();
  }catch(e){ console.error('Failed to send ids',e); }
}

/* -------------------------------------------------------------------------
 *  Load all videos once
 * ----------------------------------------------------------------------- */
const queueList = document.getElementById('queueList');
const loader = document.getElementById('loader');
let videos = [], displayedCount = 0;
const BATCH_SIZE = 30;
let currentIndex = 0;

async function loadVideos(){
  loader.textContent = 'Fetching videos...';
  try{
    const res = await fetch(BACKEND);
    videos = await res.json();
    loader.remove();
    renderNextBatch();
  }catch{
    loader.textContent = 'âŒ Failed to load videos from backend';
  }
}

/* -------------------------------------------------------------------------
 *  Render next batch (30) of cards
 * ----------------------------------------------------------------------- */
function renderNextBatch(){
  const batch = videos.slice(displayedCount, displayedCount+BATCH_SIZE);
  displayedCount += batch.length;
  batch.forEach((v,i)=>{
    const card = document.createElement('div');
    card.className = 'queue-item';
    const absIdx = displayedCount - batch.length + i;
    card.innerHTML = `
      <div class="thumb" style="background-image:url('${v.archive_org_iframe_image_link||""}')"></div>
      <div class="q-title">${v.title||'Untitled'}</div>
      <div class="q-sub">By ${v.username||'Unknown'}</div>
      <div class="q-id">ID: ${v.id||'?'}</div>
      <div class="q-link">Linkâ€¯1: <a href="${v.link_1}" target="_blank">${v.link_1||'No link'}</a></div>
      <div class="q-link">Linkâ€¯2: <a href="${v.link_2}" target="_blank">${v.link_2||'No link'}</a></div>
    `;
    card.onclick = () => playInline(absIdx);
    queueList.appendChild(card);
    requestAnimationFrame(()=>card.classList.add('visible'));
  });

  if(displayedCount >= videos.length){
    const endMsg = document.createElement('div');
    endMsg.className = 'loader';
    endMsg.textContent = 'ðŸŽ‰ All videos loaded';
    queueList.appendChild(endMsg);
  }
}

/* -------------------------------------------------------------------------
 *  Infinite scroll â€“ load more when near bottom
 * ----------------------------------------------------------------------- */
queueList.addEventListener('scroll',()=>{
  const nearBottom = queueList.scrollTop + queueList.clientHeight >= queueList.scrollHeight-150;
  if(nearBottom && displayedCount < videos.length) renderNextBatch();
});

/* -------------------------------------------------------------------------
 *  Android bridge helpers
 * ----------------------------------------------------------------------- */
function hasAndroidBridge(){
  return (typeof Android !== 'undefined' && Android !== null);
}

/* -------------------------------------------------------------------------
 *  Decide if a video should have ads (based on phone_number)
 * ----------------------------------------------------------------------- */
function shouldShowAds(videoData){
  const pn = videoData.phone_number;
  return pn && pn!=='NULL' && pn!=='null';
}

/* -------------------------------------------------------------------------
 *  Rewardâ€‘ad callbacks (called from native side)
 * ----------------------------------------------------------------------- */
window.onAdPreloaded = function(){ console.log('âœ… onAdPreloaded'); };
window.onAdFailedToPreload = function(){ console.warn('âš ï¸ onAdFailedToPreload'); };
window.onAdNotAvailable = function(){
  console.warn('âš ï¸ onAdNotAvailable â€“ resuming video (no ad).');
  if(pendingAdVideo && pendingAdVideo._wasPausedForAd){
    pendingAdVideo._wasPausedForAd = false;
    pendingAdVideo.play().catch(()=>{});
  }
  pendingAdVideo = null;
  hideAdModal();
};
window.onAdCompleted = function(targetUrl){
  console.log('âœ… onAdCompleted â†’',targetUrl);
  if(pendingAdVideo && pendingAdVideo._wasPausedForAd){
    pendingAdVideo._wasPausedForAd = false;
    pendingAdVideo.play().catch(()=>{});
  }
  pendingAdVideo = null;
  hideAdModal();

  // preload the next ad
  try{
    if(hasAndroidBridge() && typeof Android.preloadRewardedAd === 'function')
      Android.preloadRewardedAd();
  }catch(e){ console.warn('preload after completion failed',e); }

  // open any URL the native side wants us to show
  if(targetUrl && targetUrl!=='null' && targetUrl!==''){
    try{
      if(hasAndroidBridge() && typeof Android.loadUrlInWebView === 'function')
        Android.loadUrlInWebView(targetUrl);
      else window.location.href = targetUrl;
    }catch(e){ console.error('failed to open targetUrl',e); }
  }
};

/* -------------------------------------------------------------------------
 *  Variables for adâ€‘prompt handling
 * ----------------------------------------------------------------------- */
let pendingAdVideo = null;           // video that is paused because of an ad point
let adCountdownTimer = null;        // interval id for the 45â€‘sec wait
let adCountdownRemaining = 45;

/* -------------------------------------------------------------------------
 *  Helper: exit fullscreen (if any) before showing modal
 * ----------------------------------------------------------------------- */
function exitFullScreenIfNeeded(cb){
  if(document.fullscreenElement || document.webkitFullscreenElement){
    const exit = document.exitFullscreen?.() || document.webkitExitFullscreen?.();
    Promise.resolve(exit).then(()=>cb && cb()).catch(()=>cb && cb());
  }else{
    cb && cb();
  }
}

/* -------------------------------------------------------------------------
 *  Modal UI helpers
 * ----------------------------------------------------------------------- */
function hideAdModal(){
  const modal = document.getElementById('adModal');
  if(modal) modal.classList.add('hidden');

  const cnt = document.getElementById('countdownContainer');
  const wait = document.getElementById('modalWaitBtn');
  if(cnt) cnt.classList.add('hidden');
  if(wait) wait.classList.remove('hidden');

  if(adCountdownTimer){
    clearInterval(adCountdownTimer);
    adCountdownTimer = null;
  }
}

function resumePendingVideo(){
  if(pendingAdVideo && pendingAdVideo._wasPausedForAd){
    pendingAdVideo._wasPausedForAd = false;
    pendingAdVideo.play().catch(()=>{});
  }
  pendingAdVideo = null;
}

/* Show the ad prompt â€“ pause video, exit fullscreen, then open modal */
function showAdPrompt(video){
  if(!video) return;
  pendingAdVideo = video;
  video.pause();
  video._wasPausedForAd = true;

  // reset modal UI
  const waitBtn = document.getElementById('modalWaitBtn');
  const cnt = document.getElementById('countdownContainer');
  const cntNum = document.getElementById('countdownNumber');
  if(waitBtn) waitBtn.classList.remove('hidden');
  if(cnt) cnt.classList.add('hidden');
  if(cntNum) cntNum.textContent = '45';
  if(adCountdownTimer){
    clearInterval(adCountdownTimer);
    adCountdownTimer = null;
  }

  // Ensure we are not in fullscreen before showing overlay
  exitFullScreenIfNeeded(()=>{
    const modal = document.getElementById('adModal');
    if(modal) modal.classList.remove('hidden');
  });
}

/* -------------------------------------------------------------------------
 *  Modal button handlers
 * ----------------------------------------------------------------------- */
document.getElementById('modalWatchBtn').addEventListener('click',()=>{
  // user decided to watch the ad
  if(adCountdownTimer){
    clearInterval(adCountdownTimer);
    adCountdownTimer = null;
  }
  hideAdModal(); // hide UI while native ad is shown

  if(pendingAdVideo){
    const src = pendingAdVideo.currentSrc || pendingAdVideo.src || '';
    try{
      if(hasAndroidBridge() && typeof Android.requestRewardedAd === 'function'){
        Android.requestRewardedAd(src);
        console.log('Requested rewarded ad from native');
      }else{
        console.warn('Android bridge not available â€“ resuming video');
        resumePendingVideo();
      }
    }catch(e){
      console.error('Error requesting rewarded ad',e);
      resumePendingVideo();
    }
  }
});

document.getElementById('modalWaitBtn').addEventListener('click',()=>{
  // start a 45â€‘second countdown
  const waitBtn = document.getElementById('modalWaitBtn');
  const cnt = document.getElementById('countdownContainer');
  const cntNum = document.getElementById('countdownNumber');

  if(waitBtn) waitBtn.classList.add('hidden');
  if(cnt) cnt.classList.remove('hidden');

  adCountdownRemaining = 45;
  cntNum.textContent = adCountdownRemaining;

  if(adCountdownTimer) clearInterval(adCountdownTimer);
  adCountdownTimer = setInterval(()=>{
    adCountdownRemaining--;
    if(adCountdownRemaining<=0){
      clearInterval(adCountdownTimer);
      adCountdownTimer = null;
      resumePendingVideo();
      hideAdModal();
    }else{
      cntNum.textContent = adCountdownRemaining;
    }
  },1000);
});

/* -------------------------------------------------------------------------
 *  Play an inline video (adds adâ€‘checkpoint handling)
 * ----------------------------------------------------------------------- */
function playInline(idx){
  // clean up any open ad UI before switching video
  hideAdModal();
  pendingAdVideo = null;

  currentIndex = idx;
  const v = videos[idx];
  const items = document.querySelectorAll('.queue-item');

  items.forEach((el,i)=>{
    const isActive = i===idx;
    el.classList.toggle('active',isActive);
    const thumb = el.querySelector('.thumb');
    if(isActive){
      thumb.innerHTML = `
        <video controls controlslist="nodownload" autoplay playsinline
               style="width:100%;height:100%"
               src="${v.mp4_link}"
               poster="${v.archive_org_iframe_image_link}"></video>`;
    }else{
      thumb.innerHTML = '';
      if(videos[i]) thumb.style.backgroundImage = `url('${videos[i].archive_org_iframe_image_link}')`;
    }
  });

  // scroll the selected card into view
  items[idx]?.scrollIntoView({behavior:'smooth',block:'center'});

  // store click for analytics
  if(v.id!=null) store(Number(v.id));

  // adâ€‘checkpoint handling â€“ attached after the video element exists
  requestAnimationFrame(()=>{
    const active = document.querySelector('.queue-item.active');
    if(!active) return;
    const video = active.querySelector('video');
    if(!video) return;

    // oneâ€‘time Set to remember which checkpoints already fired
    video._triggeredCheckpoints = new Set();
    video._wasPausedForAd = false;

    const adsEnabled = shouldShowAds(v);

    function onTimeUpdate(){
      if(!adsEnabled) return;
      for(const cp of AD_CHECKPOINTS){
        if(video.currentTime >= cp && !video._triggeredCheckpoints.has(cp)){
          video._triggeredCheckpoints.add(cp);
          // show our custom prompt instead of autoâ€‘playing the ad
          showAdPrompt(video);
          break; // only one checkpoint per tick
        }
      }
    }

    // clean possible previous listeners
    if(video._adTimeHandler){
      video.removeEventListener('timeupdate',video._adTimeHandler);
    }
    video._adTimeHandler = onTimeUpdate;
    video.addEventListener('timeupdate',video._adTimeHandler);
  });
}

/* -------------------------------------------------------------------------
 *  Prev / Next buttons
 * ----------------------------------------------------------------------- */
document.getElementById('prevBtn').onclick = ()=>{
  if(videos.length) playInline((currentIndex-1+videos.length)%videos.length);
};
document.getElementById('nextBtn').onclick = ()=>{
  if(videos.length) playInline((currentIndex+1)%videos.length);
};

/* -------------------------------------------------------------------------
 *  Initialise app
 * ----------------------------------------------------------------------- */
window.addEventListener('load', async ()=>{
  // send any stored clickâ€‘ids
  await sendStoredToBackend();

  // load the video list
  await loadVideos();

  // ask native side to preload the first rewarded ad
  try{
    if(hasAndroidBridge()){
      if(typeof Android.preloadRewardedAd === 'function')
        Android.preloadRewardedAd();
      else if(Android.preloadRewardedAd) Android.preloadRewardedAd();
      console.log('Requested native to preload rewarded ad (init)');
    }else{
      console.log('Android bridge not detected â€“ running in browser');
    }
  }catch(e){
    console.warn('preload request failed',e);
  }
});
</script>
</body>
</html>
