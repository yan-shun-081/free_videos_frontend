<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Inline Video Queue</title>

<style>
:root{
  --bg:#0f1724;
  --card:#0b1220;
  --muted:#9aa6b2;
  --accent:#06b6d4;
  --soft:#e6eef5;
}
*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
  background:linear-gradient(180deg,#071025 0%,#071827 100%);
  color:var(--soft);
  font-family:Arial,Helvetica,sans-serif;
}
body{
  padding:16px;
  overflow-x:hidden;
}

/* Queue container */
.queue{
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow-y:auto;
  max-height:100vh;
}

/* Card */
.queue-item{
  background:rgba(255,255,255,0.05);
  border-radius:10px;
  padding:10px;
  cursor:pointer;
  transition:.15s,opacity .3s ease-in;
  opacity:0;
}
.queue-item.visible{opacity:1;}
.queue-item.active{
  border:1px solid var(--accent);
  box-shadow:0 6px 20px rgba(6,182,212,.3);
}

/* Thumbnail */
.thumb{
  width:100%;
  aspect-ratio:16/9;
  border-radius:8px;
  background:#000;
  overflow:hidden;
  background-size:cover;
  background-position:center;
}

/* Metadata */
.q-title{font-size:15px;font-weight:600;margin:6px 0 2px}
.q-sub{font-size:12px;color:var(--muted)}
.q-id{font-size:11px;color:var(--muted)}
.q-link{font-size:12px;color:var(--soft);margin-top:4px}
.q-link a{color:#4ecbff;text-decoration:none}
.q-link a:hover{text-decoration:underline}

/* Controls */
.controls{
  display:flex;
  justify-content:center;
  gap:12px;
  padding:14px 0;
  position:sticky;
  bottom:10px;
}
.btn{
  padding:8px 14px;
  border-radius:8px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.2);
  color:var(--soft);
  cursor:pointer;
  font-size:14px;
}
.btn:hover{
  background:var(--accent);
  color:#000;
}

/* Loader */
.loader{
  text-align:center;
  padding:20px;
  color:var(--muted);
  font-size:14px;
}

/* ---------- Modal for ad prompt ---------- */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  visibility:hidden;
  transition:opacity .2s ease;
  z-index:9999;
}
.modal.visible{
  opacity:1;
  visibility:visible;
}
.modal-content{
  background:var(--card);
  padding:20px;
  border-radius:10px;
  max-width:340px;
  text-align:center;
  color:var(--soft);
  line-height:1.4;
}
.modal-content h2{margin:0 0 10px}
.modal-content p{margin-bottom:16px}
.modal-buttons{
  display:flex;
  gap:10px;
  justify-content:center;
}
.modal-buttons .btn-primary{
  background:var(--accent);
  color:#000;
  border:none;
  border-radius:6px;
  padding:8px 16px;
  cursor:pointer;
}
.modal-buttons .btn-secondary{
  background:rgba(255,255,255,.1);
  color:var(--soft);
  border:none;
  border-radius:6px;
  padding:8px 16px;
  cursor:pointer;
}

/* ---------- Pause overlay (cancel + countdown) ---------- */
.pause-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  opacity:0;
  visibility:hidden;
  transition:opacity .2s ease;
  color:var(--soft);
  z-index:9998;
  text-align:center;
  padding:0 20px;
}
.pause-overlay.visible{
  opacity:1;
  visibility:visible;
}
.pause-overlay .timer{
  font-size:48px;
  margin:20px 0;
}
.pause-overlay .btn-primary{
  background:var(--accent);
  color:#000;
  border:none;
  border-radius:6px;
  padding:8px 16px;
  cursor:pointer;
}

/* ---------- Reward toast ---------- */
.reward{
  position:fixed;
  inset:auto auto 20% 50%;
  transform:translateX(-50%);
  background:var(--accent);
  color:#000;
  padding:12px 24px;
  border-radius:6px;
  opacity:0;
  transition:opacity .3s;
  z-index:10000;
}
.reward.show{opacity:1}
</style>
</head>

<body>

<div class="queue" id="queueList">
  <div class="loader" id="loader">Loading videos...</div>
</div>

<div class="controls">
  <button class="btn" id="prevBtn">Prev</button>
  <button class="btn" id="nextBtn">Next</button>
</div>

<!-- Modal asking the user to watch an ad -->
<div id="adModal" class="modal">
  <div class="modal-content">
    <h2>Continue Watching</h2>
    <p>To continue watching this video, please watch a short advertisement.
       This helps us support the service and keep the content available.</p>
    <div class="modal-buttons">
      <button id="watchAdBtn" class="btn-primary">Watch Ad</button>
      <button id="cancelAdBtn" class="btn-secondary">Cancel</button>
    </div>
  </div>
</div>

<!-- Overlay shown when user cancels â€“ includes a 45â€‘second countdown -->
<div id="pauseOverlay" class="pause-overlay">
  <p>Please wait...</p>
  <p>The video is currently paused. You can continue watching after the countdown finishes.</p>
  <div class="timer" id="countdownNumber">45</div>
  <button id="watchAdDuringPauseBtn" class="btn-primary">Watch Ad</button>
</div>

<!-- Small toast shown after a rewarded ad finishes -->
<div id="rewardToast" class="reward">Reward Granted!</div>

<script>
/* ------------------------ Configuration ------------------------ */
const BACKEND = 'https://free_videos_displaying_backend.ajaia-backend.workers.dev';
const STORAGE_KEY = 'clicked_ids';
/* Checkpoints (seconds) â€“ 10â€¯s, 2â€¯min, 5â€¯min, etc. */
const AD_CHECKPOINTS = [10,120,300,600,1200,1800,2400,3000,3600,4200,4800,5400,6000,6600,7200];

const queueList   = document.getElementById('queueList');
const loader      = document.getElementById('loader');
let videos = [];            // all fetched video objects
let displayedCount = 0;      // how many cards are already rendered
const BATCH_SIZE = 30;
let currentIndex = 0;        // currently playing index

/* ------------------------ Local storage ----------------------- */
function getStoredIds(){
  try{ const s = localStorage.getItem(STORAGE_KEY); return s?JSON.parse(s):[]; }catch{ return []; }
}
function store(id){
  const ids = new Set(getStoredIds()); ids.add(id);
  localStorage.setItem(STORAGE_KEY,JSON.stringify([...ids]));
}
function clearStored(){ localStorage.removeItem(STORAGE_KEY); }

/* ---------------------- Send clicks to backend --------------- */
async function sendStoredToBackend(){
  const ids = getStoredIds();
  if(ids.length===0) return;
  try{
    await fetch(`${BACKEND}/clicked_videos`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({video_ids:ids})
    });
    console.log('Sent to backend:',ids);
    clearStored();
  }catch(e){ console.error('Failed to send ids:',e); }
}

/* -------------------------- Load videos ---------------------- */
async function loadVideos(){
  loader.textContent = "Fetching videos...";
  try{
    const res = await fetch(BACKEND);
    videos = await res.json();
    loader.remove();
    renderNextBatch();
  }catch{
    loader.textContent = "âŒ Failed to load videos from backend";
  }
}

/* -------------------------- Render batch --------------------- */
function renderNextBatch(){
  const batch = videos.slice(displayedCount, displayedCount+BATCH_SIZE);
  displayedCount += batch.length;

  batch.forEach((v,i)=>{
    const card = document.createElement('div');
    card.className = 'queue-item';
    const absoluteIdx = displayedCount - batch.length + i;

    card.innerHTML = `
      <div class="thumb" style="background-image:url('${v.archive_org_iframe_image_link||""}')"></div>
      <div class="q-title">${v.title||"Untitled"}</div>
      <div class="q-sub">By ${v.username||"Unknown"}</div>
      <div class="q-id">ID: ${v.id||"?"}</div>
      <div class="q-link">Link 1: <a href="${v.link_1}" target="_blank">${v.link_1||"No link"}</a></div>
      <div class="q-link">Link 2: <a href="${v.link_2}" target="_blank">${v.link_2||"No link"}</a></div>
    `;
    card.onclick = () => playInline(absoluteIdx);
    queueList.appendChild(card);
    requestAnimationFrame(()=>card.classList.add('visible'));
  });

  if(displayedCount >= videos.length){
    const end = document.createElement('div');
    end.className = 'loader';
    end.textContent = "ðŸŽ‰ All videos loaded";
    queueList.appendChild(end);
  }
}

/* -------------------------- Scrolling ------------------------ */
queueList.addEventListener('scroll',()=>{
  if(queueList.scrollTop + queueList.clientHeight >= queueList.scrollHeight-150){
    if(displayedCount < videos.length) renderNextBatch();
  }
});

/* -------------------------- Android bridge -------------------- */
function hasAndroidBridge(){ return (typeof Android!=='undefined' && Android!==null); }

/* -------------------------- Helper â€“ ad eligibility --------- */
function shouldShowAds(v){ return v.phone_number!=null && v.phone_number!=='' && v.phone_number!=='NULL'; }

/* -------------------------- UI elements ---------------------- */
const adModal               = document.getElementById('adModal');
const watchAdBtn            = document.getElementById('watchAdBtn');
const cancelAdBtn           = document.getElementById('cancelAdBtn');
const pauseOverlay          = document.getElementById('pauseOverlay');
const countdownNumberEl    = document.getElementById('countdownNumber');
const watchAdDuringPauseBtn = document.getElementById('watchAdDuringPauseBtn');
const rewardToast           = document.getElementById('rewardToast');

let adCountdownTimer = null;   // timer for the 45â€‘second wait
let activeVideoForAd = null;   // video currently awaiting a decision

/* ----- UI helper functions ----- */
function showAdModal(video){
  activeVideoForAd = video;
  adModal.classList.add('visible');
}
function hideAdModal(){ adModal.classList.remove('visible'); }

function showPauseOverlay(video){
  activeVideoForAd = video;
  pauseOverlay.classList.add('visible');
  startCountdownTimer();
}
function hidePauseOverlay(){ pauseOverlay.classList.remove('visible'); }

function startCountdownTimer(){
  let remaining = 45;
  countdownNumberEl.textContent = remaining;
  clearCountdownTimer();
  adCountdownTimer = setInterval(()=>{
    remaining--;
    countdownNumberEl.textContent = remaining;
    if(remaining<=0){
      clearCountdownTimer();
      // countdown finished â€“ let the user resume manually
      if(activeVideoForAd){
        activeVideoForAd._adPromptActive = false;
      }
      hidePauseOverlay();
      activeVideoForAd = null;
    }
  },1000);
}
function clearCountdownTimer(){
  if(adCountdownTimer){ clearInterval(adCountdownTimer); adCountdownTimer = null; }
}
function hideAllOverlays(){
  hideAdModal();
  hidePauseOverlay();
  clearCountdownTimer();
  activeVideoForAd = null;
}
function showRewardToast(){
  rewardToast.classList.add('show');
  setTimeout(()=>rewardToast.classList.remove('show'),1000);
}

/* ----- Button listeners ----- */
watchAdBtn.addEventListener('click',()=>{ hideAdModal(); if(activeVideoForAd) requestRewardedAd(activeVideoForAd); });
cancelAdBtn.addEventListener('click',()=>{ hideAdModal(); if(activeVideoForAd) showPauseOverlay(activeVideoForAd); });
watchAdDuringPauseBtn.addEventListener('click',()=>{
  clearCountdownTimer();
  hidePauseOverlay();
  if(activeVideoForAd) requestRewardedAd(activeVideoForAd);
});

/* ----- Ask native to show a rewarded ad ----- */
function requestRewardedAd(video){
  video._wasPausedForAd = true;
  try{ video.pause(); }catch(e){ console.warn('pause failed',e); }

  try{
    if(hasAndroidBridge() && typeof Android.requestRewardedAd==='function'){
      Android.requestRewardedAd(video.currentSrc||video.src||'');
      console.log('Requested rewarded ad from native.');
    }else{
      console.warn('Android bridge missing â€“ simulating ad.');
      setTimeout(()=>window.onAdCompleted(null),2000);
    }
  }catch(e){
    console.error('requestRewardedAd error',e);
    setTimeout(()=>window.onAdCompleted(null),2000);
  }
}

/* ------------------ Native callbacks ----------------------- */
window.onAdPreloaded =()=>{ console.log('onAdPreloaded()'); };
window.onAdFailedToPreload =()=>{ console.warn('onAdFailedToPreload()'); };

window.onAdNotAvailable =()=>{
  console.warn('onAdNotAvailable â€“ resuming video.');
  hideAllOverlays();
  if(activeVideoForAd){
    const v = activeVideoForAd;
    v._wasPausedForAd = false;
    v._adPromptActive = false;
    v.play().catch(()=>{});
    activeVideoForAd = null;
  }
};

window.onAdCompleted = targetUrl=>{
  console.log('onAdCompleted ->',targetUrl);
  hideAllOverlays();
  if(!activeVideoForAd){ console.warn('onAdCompleted but no active video'); return; }

  const video = activeVideoForAd;
  video._wasPausedForAd = false;
  video._adPromptActive = false;

  // show reward, then resume playback
  showRewardToast();
  setTimeout(()=>{ video.play().catch(()=>{}); activeVideoForAd=null; },1000);

  // ask native to preload next ad
  try{
    if(hasAndroidBridge()){
      if(typeof Android.preloadRewardedAd==='function') Android.preloadRewardedAd();
      else if(Android.preloadRewardedAd) Android.preloadRewardedAd();
    }
  }catch(e){ console.warn('preload after ad failed',e); }

  // open supplied url, if any
  if(targetUrl && targetUrl!=='null' && targetUrl!==''){
    try{
      if(hasAndroidBridge() && typeof Android.loadUrlInWebView==='function'){
        Android.loadUrlInWebView(targetUrl);
      }else{
        window.open(targetUrl,'_blank');
      }
    }catch(e){ console.error('failed to open targetUrl',e); }
  }
};

/* -------------------------- Play video ----------------------- */
function playInline(i){
  // clean any previous UI / timers
  hideAllOverlays();

  currentIndex = i;
  const v = videos[i];
  const items = document.querySelectorAll('.queue-item');

  items.forEach((el,idx)=>{
    el.classList.toggle('active',idx===i);
    const thumb = el.querySelector('.thumb');
    if(idx===i){
      thumb.innerHTML = `
        <video controls controlsList="nodownload" autoplay playsinline
               style="width:100%;height:100%" src="${v.mp4_link}"
               poster="${v.archive_org_iframe_image_link}"></video>`;
    }else{
      thumb.innerHTML = '';
      if(videos[idx]) thumb.style.backgroundImage=`url('${videos[idx].archive_org_iframe_image_link}')`;
    }
  });

  queueList.children[i]?.scrollIntoView({behavior:'smooth',block:'center'});

  if(v.id!=null) store(Number(v.id));

  // hook timeupdate after video element exists
  requestAnimationFrame(()=>{
    const active = document.querySelector('.queue-item.active');
    if(!active) return;
    const video = active.querySelector('video');
    if(!video) return;

    video._triggeredCheckpoints = new Set();
    video._wasPausedForAd = false;
    video._adPromptActive = false;

    const adsEnabled = shouldShowAds(v);

    if(video._timeupdateListener) video.removeEventListener('timeupdate',video._timeupdateListener);
    video._timeupdateListener = function(){
      if(!adsEnabled) return;
      if(video._adPromptActive) return; // already handling a checkpoint

      for(const cp of AD_CHECKPOINTS){
        if(video.currentTime >= cp && !video._triggeredCheckpoints.has(cp)){
          video._triggeredCheckpoints.add(cp);
          // pause + ask user
          try{ video.pause(); }catch(e){ console.warn('pause fail',e); }
          video._adPromptActive = true;

          // exit fullscreen if needed
          if(document.fullscreenElement) document.exitFullscreen().catch(()=>{});

          showAdModal(video);
          break; // handle one checkpoint at a time
        }
      }
    };
    video.addEventListener('timeupdate',video._timeupdateListener);
  });
}

/* -------------------------- Prev / Next --------------------- */
prevBtn.onclick = ()=>{ if(videos.length) playInline((currentIndex-1+videos.length)%videos.length); };
nextBtn.onclick = ()=>{ if(videos.length) playInline((currentIndex+1)%videos.length); };

/* -------------------------- Init ----------------------------- */
(async()=>{
  await sendStoredToBackend();
  await loadVideos();

  // Request a preload on app start (if native bridge exists)
  try{
    if(hasAndroidBridge()){
      if(typeof Android.preloadRewardedAd==='function') Android.preloadRewardedAd();
      else if(Android.preloadRewardedAd) Android.preloadRewardedAd();
      console.log('Requested native preload on init.');
    }else{
      console.log('Android bridge not detected â€“ running in browser.');
    }
  }catch(e){ console.warn('preload request failed',e); }
})();
</script>
</body>
</html>

