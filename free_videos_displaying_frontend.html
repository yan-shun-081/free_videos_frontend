
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Inline Video Queue</title>
<style>
:root{
  --bg:#0f1724;
  --card:#0b1220;
  --muted:#9aa6b2;
  --accent:#06b6d4;
  --soft:#e6eef5;
}
*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
  background:linear-gradient(180deg,#071025 0%, #071827 100%);
  color:var(--soft);
  font-family:Arial, Helvetica, sans-serif;
}
body{
  padding:16px;
  overflow-x:hidden;
}

/* ----- top notice ----- */
.notice{
  background:rgba(255,255,255,0.08);
  border:1px solid var(--accent);
  color:var(--soft);
  text-align:center;
  padding:8px;
  margin-bottom:12px;
  border-radius:8px;
  font-size:14px;
  font-weight:600;
}

/* Queue */
.queue{
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow-y:auto;
  max-height:100vh;
}
.queue-item{
  background:rgba(255,255,255,0.05);
  border-radius:10px;
  padding:10px;
  cursor:pointer;
  transition:0.15s,opacity .3s ease-in;
  opacity:0;
}
.queue-item.visible{opacity:1;}
.queue-item.active{
  border:1px solid var(--accent);
  box-shadow:0 6px 20px rgba(6,182,212,.3);
}
.thumb{
  width:100%;
  aspect-ratio:16/9;
  border-radius:8px;
  background:#000;
  overflow:hidden;
  background-size:cover;
  background-position:center;
}
.q-title{font-size:15px;font-weight:600;margin:6px 0 2px}
.q-sub{font-size:12px;color:var(--muted)}
.q-id{font-size:11px;color:var(--muted)}
.q-link{font-size:12px;color:var(--soft);margin-top:4px}
.q-link a{color:#4ecbff;text-decoration:none}
.q-link a:hover{text-decoration:underline}

/* ‚ÄúShare‚Äù button */
.share-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  margin-left:8px;
  padding:4px 8px;
  font-size:13px;
  font-weight:600;
  color:#000;
  background:var(--accent);
  border:none;
  border-radius:6px;
  cursor:pointer;
  transition:background .2s;
}
.share-btn:hover{
  background:#4ecbff;
}

/* Controls */
.controls{
  display:flex;
  justify-content:center;
  gap:12px;
  padding:14px 0;
  position:sticky;
  bottom:10px;
}
.btn{
  padding:8px 14px;
  border-radius:8px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.2);
  color:var(--soft);
  cursor:pointer;
  font-size:14px;
}
.btn:hover{
  background:var(--accent);
  color:#000;
}

/* Loader */
.loader{
  text-align:center;
  padding:20px;
  color:var(--muted);
  font-size:14px;
}

/* Mobile */
@media (max-width:640px){
  h1{font-size:1.8rem}
  h2{font-size:1.25rem}
  iframe{height:350px !important}
}
</style>
</head>

<body>

<!-- ----- highlighted notice ----- -->
<div class="notice">
  All content belongs to its respective owners. Credits to original creators.
</div>

<!-- Queue container -->
<div class="queue" id="queueList">
  <div class="loader" id="loader">Loading videos...</div>
</div>

<!-- Controls -->
<div class="controls">
  <button class="btn" id="prevBtn">Prev</button>
  <button class="btn" id="nextBtn">Next</button>
</div>

<script>
/* -------------------------------------------------------------------------
 *  Constants & small helpers
 * ----------------------------------------------------------------------- */
const BACKEND     = 'https://free_videos_displaying_backend.ajaia-backend.workers.dev';
const STORAGE_KEY = 'clicked_ids';

/* Page‚Äëlevel metadata that must be part of every share */
const PAGE_ID   = 1;
const PAGE_NAME = 'free videos content';

/* -------------------------------------------------------------------------
 *  LocalStorage helpers
 * ----------------------------------------------------------------------- */
function getStoredIds(){
  try{
    const s = localStorage.getItem(STORAGE_KEY);
    return s ? JSON.parse(s) : [];
  }catch{ return []; }
}
function store(id){
  const ids = new Set(getStoredIds());
  ids.add(id);
  localStorage.setItem(STORAGE_KEY,JSON.stringify([...ids]));
}
function clearStored(){ localStorage.removeItem(STORAGE_KEY); }

/* -------------------------------------------------------------------------
 *  Send stored clicks to backend
 * ----------------------------------------------------------------------- */
async function sendStoredToBackend(){
  const ids = getStoredIds();
  if(!ids.length) return;
  try{
    await fetch(`${BACKEND}/clicked_videos`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({video_ids:ids})
    });
    console.log('Sent to backend:',ids);
    clearStored();
  }catch(e){ console.error('Failed to send ids',e); }
}

/* -------------------------------------------------------------------------
 *  Load all videos once
 * ----------------------------------------------------------------------- */
const queueList = document.getElementById('queueList');
const loader    = document.getElementById('loader');
let videos = [], displayedCount = 0;
const BATCH_SIZE = 30;
let currentIndex = 0;

async function loadVideos(){
  loader.textContent = 'Fetching videos...';
  try{
    const res = await fetch(BACKEND);
    videos = await res.json();
    loader.remove();
    renderNextBatch();
  }catch{
    loader.textContent = '‚ùå Failed to load videos from backend';
  }
}

/* -------------------------------------------------------------------------
 *  Render next batch (30) of cards
 * ----------------------------------------------------------------------- */
function renderNextBatch(){
  const batch = videos.slice(displayedCount, displayedCount+BATCH_SIZE);
  displayedCount += batch.length;
  batch.forEach((v,i)=>{
    const card = document.createElement('div');
    card.className = 'queue-item';
    const absIdx = displayedCount - batch.length + i;

    card.innerHTML = `
      <div class="thumb" style="background-image:url('${v.archive_org_iframe_image_link||""}')"></div>
      <div class="q-title">${v.title||'Untitled'}</div>
      <div class="q-sub">By ${v.username||'Unknown'}</div>
      <div class="q-id">ID: ${v.id||'?'}</div>
      <div class="q-link">Link‚ÄØ1: <a href="${v.link_1}" target="_blank">${v.link_1||'No link'}</a></div>
      <div class="q-link">Link‚ÄØ2: <a href="${v.link_2}" target="_blank">${v.link_2||'No link'}</a></div>
      <button class="share-btn" data-index="${absIdx}">Share</button>
    `;

    // Click on the whole card ‚Üí play video
    card.onclick = () => playInline(absIdx);
    queueList.appendChild(card);
    requestAnimationFrame(()=>card.classList.add('visible'));
  });

  if(displayedCount >= videos.length){
    const endMsg = document.createElement('div');
    endMsg.className = 'loader';
    endMsg.textContent = 'üéâ All videos loaded';
    queueList.appendChild(endMsg);
  }
}

/* -------------------------------------------------------------------------
 *  Infinite scroll ‚Äì load more when near bottom
 * ----------------------------------------------------------------------- */
queueList.addEventListener('scroll',()=>{
  const nearBottom = queueList.scrollTop + queueList.clientHeight >= queueList.scrollHeight - 150;
  if(nearBottom && displayedCount < videos.length) renderNextBatch();
});

/* -------------------------------------------------------------------------
 *  Play an inline video (no ad checkpoint logic)
 * ----------------------------------------------------------------------- */
function playInline(idx){
  currentIndex = idx;
  const v = videos[idx];
  const items = document.querySelectorAll('.queue-item');

  items.forEach((el,i)=>{
    const isActive = i===idx;
    el.classList.toggle('active',isActive);
    const thumb = el.querySelector('.thumb');

    if(isActive){
      // remove the background image so the video isn‚Äôt covered by it
      thumb.style.backgroundImage = '';
      thumb.innerHTML = `
        <video controls controlslist="nodownload" autoplay playsinline
               style="width:100%;height:100%"
               src="${v.mp4_link}"
               poster="${v.archive_org_iframe_image_link}"></video>`;
    }else{
      // restore the thumbnail background when not active
      thumb.innerHTML = '';
      if(videos[i]) thumb.style.backgroundImage = `url('${videos[i].archive_org_iframe_image_link}')`;
    }
  });

  // scroll newly‚Äëactive item into view
  items[idx]?.scrollIntoView({behavior:'smooth',block:'center'});

  // store the click for analytics
  if(v.id!=null) store(Number(v.id));
}

/* -------------------------------------------------------------------------
 *  Prev / Next buttons
 * ----------------------------------------------------------------------- */
document.getElementById('prevBtn').onclick = ()=>{
  if(videos.length) playInline((currentIndex-1+videos.length)%videos.length);
};
document.getElementById('nextBtn').onclick = ()=>{
  if(videos.length) playInline((currentIndex+1)%videos.length);
};

/* -------------------------------------------------------------------------
 *  Share functionality ‚Äì composite image
 * ----------------------------------------------------------------------- */

/**
 * Build the plain‚Äëtext version used for the WhatsApp fallback.
 */
function buildShareText(video){
  const title   = video.title   || 'Untitled video';
  const vidId   = video.id ?? '-';
  const user    = video.username || '-';
  return `Page name: ${PAGE_NAME}
Page ID: ${PAGE_ID}
Video title: ${title}
Video ID: ${vidId}
Username: ${user}
App name: YAN_1
Developer: YAN`;
}

/**
 * Create a single image that merges the thumbnail and the required information.
 * Returns a Blob (image/jpeg).
 */
async function createCompositeImage(video){
  const imgUrl = video.archive_org_iframe_image_link;
  if(!imgUrl) throw new Error('No thumbnail URL');

  // ----- load thumbnail (must be CORS‚Äëenabled) -----
  const img = await new Promise((resolve, reject) => {
    const i = new Image();
    i.crossOrigin = 'anonymous';
    i.onload  = () => resolve(i);
    i.onerror = reject;
    i.src = imgUrl;
  });

  // ----- calculate sizes -----
  const MAX_WIDTH = 800;                     // never exceed this width
  const scale     = Math.min(1, MAX_WIDTH / img.width);
  const thumbW    = img.width  * scale;
  const thumbH    = img.height * scale;

  // ----- text that will appear under the thumbnail -----
  const lines = [
    `Page name: ${PAGE_NAME}`,
    `Page ID: ${PAGE_ID}`,
    `Video title: ${video.title || 'Untitled'}`,
    `Video ID: ${video.id ?? '-'}`,
    `Username: ${video.username || '-'}`,
    `App name: YAN_1`,
    `Developer: YAN`
  ];

  const padding    = 20;   // padding around the text block
  const lineHeight = 28;   // vertical spacing per line
  const textHeight = lines.length * lineHeight + padding;
  const canvasW    = Math.round(thumbW);
  const canvasH    = Math.round(thumbH + textHeight);

  // ----- draw onto canvas -----
  const canvas = document.createElement('canvas');
  canvas.width  = canvasW;
  canvas.height = canvasH;
  const ctx = canvas.getContext('2d');

  // white background
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,canvasW,canvasH);

  // thumbnail on top
  ctx.drawImage(img, 0, 0, thumbW, thumbH);

  // text under the thumbnail
  ctx.fillStyle = '#333333';               // dark‚Äëgray for good contrast
  ctx.font = '20px Arial';
  ctx.textBaseline = 'top';
  const startY = thumbH + padding/2;
  lines.forEach((txt, idx) => {
    ctx.fillText(txt, padding, startY + idx * lineHeight);
  });

  // ----- export to Blob -----
  return new Promise((resolve, reject) => {
    canvas.toBlob(blob => {
      if (blob) resolve(blob);
      else reject(new Error('Canvas toBlob failed'));
    }, 'image/jpeg', 0.92);
  });
}

/**
 * Share routine:
 *   1Ô∏è‚É£ Try native Web‚ÄëShare API.
 *   2Ô∏è‚É£ If that isn‚Äôt available (e.g. Android WebView), call the Android bridge.
 *   3Ô∏è‚É£ If neither works, fall back to a WhatsApp text link.
 */
async function shareThumbnail(idx){
  const video = videos[idx];
  if(!video) return;

  /* --------------------------------------------------------------
   *  1Ô∏è‚É£ Try the native Web‚ÄëShare API (works on browsers)
   * -------------------------------------------------------------- */
  try{
    if (navigator.canShare && navigator.canShare({files: []})){
      const blob = await createCompositeImage(video);
      const file = new File([blob], 'video-share.jpg', {type: blob.type});
      if (navigator.share && navigator.canShare({files:[file]})){
        await navigator.share({files:[file], title: video.title || ''});
        console.log('‚úÖ shared via standard Web‚ÄëShare');
        return;               // success ‚Äì stop here
      }
    }
  }catch(e){
    console.warn('Web‚ÄëShare API not usable (expected in WebView)', e);
  }

  /* --------------------------------------------------------------
   *  2Ô∏è‚É£ Android bridge ‚Äì the only way to attach an image inside a WebView
   * -------------------------------------------------------------- */
  if (window.Android && typeof window.Android.shareImage === 'function'){
    try{
      const blob = await createCompositeImage(video);
      const dataUrl = await new Promise((res,rej)=>{
        const fr = new FileReader();
        fr.onload  = () => res(fr.result);   // e.g. "data:image/jpeg;base64,‚Ä¶"
        fr.onerror = rej;
        fr.readAsDataURL(blob);
      });
      const fileName = `video_${video.id ?? Date.now()}.jpg`;
      const text     = buildShareText(video);
      window.Android.shareImage(dataUrl, fileName, video.title||'Video', text);
      console.log('‚úÖ delegated share to Android bridge');
      return;               // success ‚Äì stop here
    }catch(e){
      console.error('Bridge share failed ‚Üí fallback', e);
    }
  }

  /* --------------------------------------------------------------
   *  3Ô∏è‚É£ Final fallback ‚Äì WhatsApp text‚Äëonly link
   * -------------------------------------------------------------- */
  const wa = `https://api.whatsapp.com/send?text=${encodeURIComponent(buildShareText(video))}`;
  window.open(wa, '_blank');
}

/* Delegated click listener ‚Äì catches clicks on any .share‚Äëbtn inside the queue */
queueList.addEventListener('click', e => {
  const btn = e.target.closest('.share-btn');
  if (!btn) return;               // not a share button
  e.stopPropagation();            // prevent the card click ‚Üí play video

  const idx = Number(btn.dataset.index);
  if (!Number.isNaN(idx)){
    shareThumbnail(idx);
  }
});

/* -------------------------------------------------------------------------
 *  Initialise app
 * ----------------------------------------------------------------------- */
window.addEventListener('load', async ()=>{
  // send any stored click‚Äëids (analytics)
  await sendStoredToBackend();

  // load the video list
  await loadVideos();
});
</script>

</body>
</html>
