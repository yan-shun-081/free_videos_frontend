<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Inline Video Queue</title>

<style>
:root{
  --bg:#0f1724;
  --card:#0b1220;
  --muted:#9aa6b2;
  --accent:#06b6d4;
  --soft:#e6eef5;
}
*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
  background:linear-gradient(180deg,#071025 0%, #071827 100%);
  color:var(--soft);
  font-family:Arial, Helvetica, sans-serif;
}
body{
  padding:16px;
  overflow-x:hidden;
}

/* Queue Container */
.queue{
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow-y:auto;
  max-height:100vh;
}

/* Item Card */
.queue-item{
  background:rgba(255,255,255,0.05);
  border-radius:10px;
  padding:10px;
  cursor:pointer;
  transition:0.15s, opacity 0.3s ease-in;
  opacity:0;
}
.queue-item.visible{opacity:1;}
.queue-item.active{
  border:1px solid var(--accent);
  box-shadow:0 6px 20px rgba(6,182,212,0.3);
}

/* Thumbnail ‚Äì becomes the fullscreen element */
.thumb{
  width:100%;
  aspect-ratio:16/9;
  border-radius:8px;
  background:#000;
  overflow:hidden;
  background-size:cover;
  background-position:center;
  position:relative;               /* important for absolute overlay */
}

/* Metadata */
.q-title{font-size:15px;font-weight:600;margin:6px 0 2px}
.q-sub{font-size:12px;color:var(--muted)}
.q-id{font-size:11px;color:var(--muted)}
.q-link{font-size:12px;color:var(--soft); margin-top:4px}
.q-link a{color:#4ecbff;text-decoration:none;}
.q-link a:hover{text-decoration:underline;}

/* Controls */
.controls{
  display:flex;
  justify-content:center;
  gap:12px;
  padding:14px 0;
  position:sticky;
  bottom:10px;
}
.btn{
  padding:8px 14px;
  border-radius:8px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.2);
  color:var(--soft);
  cursor:pointer;
  font-size:14px;
}
.btn:hover{
  background:var(--accent);
  color:#000;
}

/* Loader */
.loader{
  text-align:center;
  padding:20px;
  color:var(--muted);
  font-size:14px;
}

/* ---------- Overlay (now absolute) ---------- */
.overlay{
  inset:0;
  position:absolute;                 /* will fill its parent (thumb or body)  */
  background:rgba(0,0,0,0.9);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
  visibility:hidden;
  opacity:0;
  transition:opacity .2s ease;
}
.overlay.active{
  visibility:visible;
  opacity:1;
}
.overlay .dialog{
  background:#111;
  border-radius:12px;
  max-width:400px;
  width:90%;
  padding:20px;
  text-align:center;
}
.overlay .btn-group{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top:15px;
}
.overlay .btn-primary{
  flex:1;
  padding:10px;
  background:var(--accent);
  color:#000;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
.overlay .btn-secondary{
  flex:1;
  padding:10px;
  background:rgba(255,255,255,0.08);
  color:var(--soft);
  border:1px solid rgba(255,255,255,0.2);
  border-radius:8px;
  cursor:pointer;
}
.overlay .countdown{
  font-size:2rem;
  font-weight:600;
  margin:15px 0;
}

/* custom fullscreen button (shown over the video) */
.fullscreen-btn{
  position:absolute;
  top:8px;
  right:8px;
  background:rgba(0,0,0,0.5);
  color:#fff;
  border:none;
  border-radius:4px;
  padding:4px 8px;
  font-size:14px;
  cursor:pointer;
  z-index:10;
}

/* hide native fullscreen button (WebKit browsers) */
video::-webkit-media-controls-fullscreen-button{
  display:none;
}
</style>
</head>

<body>

<div class="queue" id="queueList">
  <div class="loader" id="loader">Loading videos...</div>
</div>

<!-- overlay used for all dialogs (prompt, countdown, reward toast) -->
<div class="overlay" id="modalOverlay"></div>

<div class="controls">
  <button class="btn" id="prevBtn">Prev</button>
  <button class="btn" id="nextBtn">Next</button>
</div>

<script>
/* ----------------------------- CONFIG ----------------------------- */
const BACKEND = 'https://free_videos_displaying_backend.ajaia-backend.workers.dev';
const STORAGE_KEY = 'clicked_ids';
const AD_CHECKPOINTS = [10,120,300,600,1200,1800,2400,3000,3600,4200,4800,5400,6000,6600,7200];

/* -------------------------- GLOBAL STATE -------------------------- */
const queueList = document.getElementById('queueList');
const loader    = document.getElementById('loader');
const overlay   = document.getElementById('modalOverlay');

let videos = [];
let displayedCount = 0;
const BATCH_SIZE = 30;
let currentIndex = 0;                // used by Prev/Next buttons
let preAdPending = false;            // true while we wait for a rewarded‚Äëad
let pendingPlayIndex = null;         // video index that should resume after ad
let currentVideoElement = null;     // <video> element currently active
let countdownInterval = null;        // reference to the 45‚Äësecond timer

/* where the overlay should be attached ‚Äì default = body */
let overlayParent = document.body;

/* -------------------------- LOCAL STORAGE -------------------------- */
function getStoredIds(){
  try{
    const stored = localStorage.getItem(STORAGE_KEY);
    return stored ? JSON.parse(stored) : [];
  }catch{ return []; }
}
function store(id){
  const ids = new Set(getStoredIds());
  ids.add(id);
  localStorage.setItem(STORAGE_KEY, JSON.stringify([...ids]));
}
function clearStored(){ localStorage.removeItem(STORAGE_KEY); }

/* --------------------------- BACKEND --------------------------- */
async function sendStoredToBackend(){
  const ids = getStoredIds();
  if(ids.length===0) return;
  try{
    await fetch(`${BACKEND}/clicked_videos`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({video_ids:ids})
    });
    console.log('Sent to backend:',ids);
    clearStored();
  }catch(err){
    console.error('Failed to send ids:',err);
  }
}
async function loadVideos(){
  loader.textContent = "Fetching videos...";
  try{
    const res = await fetch(BACKEND);
    videos = await res.json();
    loader.remove();
    renderNextBatch();
  }catch{
    loader.textContent = "‚ùå Failed to load videos from backend";
  }
}

/* --------------------------- RENDERING --------------------------- */
function renderNextBatch(){
  const nextBatch = videos.slice(displayedCount, displayedCount+BATCH_SIZE);
  displayedCount += nextBatch.length;

  nextBatch.forEach((v,i)=>{
    const card = document.createElement('div');
    card.className = 'queue-item';
    const absoluteIndex = (displayedCount - nextBatch.length) + i;
    card.innerHTML = `
      <div class="thumb" style="background-image:url('${v.archive_org_iframe_image_link||""}')"></div>
      <div class="q-title">${v.title || "Untitled"}</div>
      <div class="q-sub">By ${v.username || "Unknown"}</div>
      <div class="q-id">ID: ${v.id || "?"}</div>

      <div class="q-link">Link 1: <a href="${v.link_1}" target="_blank">${v.link_1 || "No link"}</a></div>
      <div class="q-link">Link 2: <a href="${v.link_2}" target="_blank">${v.link_2 || "No link"}</a></div>
    `;
    // click goes through the ad‚Äëprompt flow
    card.onclick = () => playInline(absoluteIndex);
    queueList.appendChild(card);
    requestAnimationFrame(()=>card.classList.add('visible'));
  });

  if(displayedCount >= videos.length){
    const endMsg = document.createElement('div');
    endMsg.className = 'loader';
    endMsg.textContent = "üéâ All videos loaded";
    queueList.appendChild(endMsg);
  }
}

/* --------------------------- SCROLL --------------------------- */
queueList.addEventListener('scroll',()=>{
  const bottomReached = queueList.scrollTop + queueList.clientHeight >= queueList.scrollHeight - 150;
  if(bottomReached && displayedCount < videos.length){
    renderNextBatch();
  }
});

/* -------------------------- ANDROID BRIDGE -------------------------- */
function hasAndroidBridge(){
  return (typeof Android !== 'undefined' && Android !== null);
}

/* simulate ad when no bridge is present */
function simulateAd(){
  console.warn('Simulating rewarded ad (no Android bridge)‚Ä¶');
  setTimeout(()=>{ window.onAdCompleted(null); },2000);
}

/* --------------------------- OVERLAY HELPERS --------------------------- */
function showOverlay(innerHTML){
  overlay.innerHTML = `<div class="dialog">${innerHTML}</div>`;
  /* move overlay to the current parent (body or active thumb) */
  if(overlay.parentNode !== overlayParent){
    overlayParent.appendChild(overlay);
  }
  overlay.classList.add('active');
}
function hideOverlay(){
  overlay.classList.remove('active');
  overlay.innerHTML = '';
}

/* --------------------------- PROMPT / COUNTDOWN --------------------------- */
function showContinueWatchingPrompt(onChoice){
  const html = `
    <h2>Continue Watching</h2>
    <p>To continue watching this video, please watch a short advertisement.<br>
    This helps us support the service and keep the content available.</p>
    <div class="btn-group">
      <button class="btn-primary" id="watchAdBtn">Watch Ad</button>
      <button class="btn-secondary" id="cancelBtn">Cancel</button>
    </div>`;
  showOverlay(html);
  document.getElementById('watchAdBtn').onclick = () => onChoice(true);
  document.getElementById('cancelBtn').onclick = () => onChoice(false);
}

/* pause‚Äëcountdown that appears when the user clicks ‚ÄúCancel‚Äù */
function showPauseCountdownOverlay(videoEl, videoIdx){
  let remaining = 45;
  const html = `
    <h2>Please Wait</h2>
    <p>The video is currently paused.<br>You can continue watching after the countdown finishes.</p>
    <div class="countdown" id="countdownTimer">${remaining}s</div>
    <button class="btn-primary" id="watchAdDuringPause">Watch Ad</button>`;
  showOverlay(html);
  const timerEl = document.getElementById('countdownTimer');
  const watchBtn = document.getElementById('watchAdDuringPause');

  if(countdownInterval) clearInterval(countdownInterval);
  countdownInterval = setInterval(()=>{
    remaining--;
    if(remaining <= 0){
      clearInterval(countdownInterval);
      countdownInterval = null;
      hideOverlay();
      videoEl.play().catch(()=>{});
    }else{
      timerEl.textContent = `${remaining}s`;
    }
  },1000);

  watchBtn.onclick = () => {
    if(countdownInterval){
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
    preAdPending = true;
    pendingPlayIndex = videoIdx;
    hideOverlay();               // remove countdown UI
    requestRewardedAd();          // directly request the ad ‚Äì no loading screen
  };
}

/* --------------------------- REWARDED‚ÄëAD REQUEST --------------------------- */
function requestRewardedAd(){
  if(currentVideoElement) currentVideoElement._wasPausedForAd = true;
  try{
    if(hasAndroidBridge()){
      if(typeof Android.requestRewardedAd === 'function'){
        Android.requestRewardedAd(currentVideoElement?.currentSrc || currentVideoElement?.src || '');
        console.log('Requested rewarded ad from native');
      }else if(Android.requestRewardedAd){
        Android.requestRewardedAd(currentVideoElement?.currentSrc || currentVideoElement?.src || '');
        console.log('Requested rewarded ad from native (fallback)');
      }else{
        simulateAd();
      }
    }else{
      simulateAd();
    }
  }catch(e){
    console.error('requestRewardedAd error',e);
    simulateAd();
  }
}

/* ---------------------------- VIDEO PLAYBACK ---------------------------- */
function playInline(i){
  /* clean up any stale UI / timers */
  hideOverlay();
  if(countdownInterval){
    clearInterval(countdownInterval);
    countdownInterval = null;
  }
  preAdPending = false;
  pendingPlayIndex = null;

  currentIndex = i;           // keep Prev/Next in sync
  const v = videos[i];
  const items = document.querySelectorAll('.queue-item');

  items.forEach((el,idx)=>{
    el.classList.toggle('active', idx===i);
    const thumb = el.querySelector('.thumb');
    if(idx===i){
      /* make the thumb the fullscreen element */
      thumb.innerHTML = `
        <video controls controlsList="nodownload nofullscreen"
               autoplay playsinline
               style="width:100%;height:100%"
               src="${v.mp4_link}"
               poster="${v.archive_org_iframe_image_link}"></video>
        <button class="fullscreen-btn" id="fsBtn_${i}">‚õ∂</button>`;
      // custom fullscreen button -------------------------------------------------
      const fsBtn = thumb.querySelector('#fsBtn_'+i);
      if(fsBtn){
        fsBtn.addEventListener('click', (e)=>{
          e.stopPropagation();           // don't trigger the card click
          if(thumb.requestFullscreen){
            thumb.requestFullscreen();
          }else if(thumb.webkitRequestFullscreen){
            thumb.webkitRequestFullscreen();
          }else if(thumb.mozRequestFullScreen){
            thumb.mozRequestFullScreen();
          }else if(thumb.msRequestFullscreen){
            thumb.msRequestFullscreen();
          }
        });
      }
      // make overlay attach to this thumb (so it follows fullscreen)
      overlayParent = thumb;
    }else{
      thumb.innerHTML = '';
      if(videos[idx]) thumb.style.backgroundImage = `url('${videos[idx].archive_org_iframe_image_link}')`;
    }
  });

  queueList.children[i]?.scrollIntoView({behavior:'smooth',block:'center'});
  if(v.id!=null) store(Number(v.id));

  /* ------- ad‚Äëcheckpoint handling ------- */
  requestAnimationFrame(()=>{
    const active = document.querySelector('.queue-item.active');
    if(!active) return;
    const videoEl = active.querySelector('video');
    if(!videoEl) return;

    currentVideoElement = videoEl;
    videoEl._triggeredCheckpoints = new Set();
    videoEl._wasPausedForAd = false;

    const adsEnabled = (v.phone_number != null && v.phone_number !== '' && v.phone_number !== 'NULL');

    const onTimeUpdate = () => {
      if(!adsEnabled) return;

      for(const checkpoint of AD_CHECKPOINTS){
        if(videoEl.currentTime >= checkpoint && !videoEl._triggeredCheckpoints.has(checkpoint)){
          videoEl._triggeredCheckpoints.add(checkpoint);
          videoEl.pause();
          showContinueWatchingPrompt((watchAd) => {
            if(watchAd){
              preAdPending = true;
              pendingPlayIndex = i;
              hideOverlay();               // close the question dialog
              requestRewardedAd();          // fire the ad (no loading overlay)
            }else{
              showPauseCountdownOverlay(videoEl, i);
            }
          });
          break; // stop checking further checkpoints until resolved
        }
      }
    };

    // detach any previous listener
    if(videoEl._timeupdateListener){
      videoEl.removeEventListener('timeupdate', videoEl._timeupdateListener);
    }
    videoEl._timeupdateListener = onTimeUpdate;
    videoEl.addEventListener('timeupdate', videoEl._timeupdateListener);
  });
}

/* --------------------------- CONTROLS --------------------------- */
prevBtn.onclick = () => {
  if(videos.length>0) playInline((currentIndex-1+videos.length)%videos.length);
};
nextBtn.onclick = () => {
  if(videos.length>0) playInline((currentIndex+1)%videos.length);
};

/* --------------------------- NATIVE CALLBACKS --------------------------- */
window.onAdPreloaded = function(){
  console.log('onAdPreloaded()');
};

window.onAdFailedToPreload = function(){
  console.warn('onAdFailedToPreload()');
};

window.onAdNotAvailable = function(){
  console.warn('onAdNotAvailable() ‚Äî resuming video (no web fallback).');
  hideOverlay();
  try{
    const active = document.querySelector('.queue-item.active');
    if(active){
      const v = active.querySelector('video');
      if(v && v._wasPausedForAd){
        v._wasPausedForAd = false;
        v.play().catch(()=>{});
      }
    }
  }catch(e){ console.error(e); }

  // clear any pending‚Äëad state
  if(preAdPending){
    preAdPending = false;
    pendingPlayIndex = null;
  }
};

window.onAdCompleted = function(targetUrl){
  console.log('onAdCompleted() ->', targetUrl);

  // ----- reward toast (1‚ÄØs) -----
  showOverlay('<p>Reward granted!</p>');
  setTimeout(()=>{
    hideOverlay();                     // toast disappears after 1‚ÄØs

    // ----- resume the video that was paused for the ad -----
    try{
      const active = document.querySelector('.queue-item.active');
      if(active){
        const v = active.querySelector('video');
        if(v && v._wasPausedForAd){
          v._wasPausedForAd = false;
          v.play().catch(()=>{});
        }
      }
    }catch(e){ console.error(e); }

    // ----- clear pending‚Äëad flags -----
    preAdPending = false;
    pendingPlayIndex = null;

    // ----- open any URL supplied by the ad -----
    if(targetUrl && targetUrl !== 'null' && targetUrl !== ''){
      try{
        if(hasAndroidBridge() && typeof Android.loadUrlInWebView === 'function'){
          Android.loadUrlInWebView(targetUrl);
        }else if(hasAndroidBridge() && Android.loadUrlInWebView){
          Android.loadUrlInWebView(targetUrl);
        }else{
          window.location.href = targetUrl;
        }
      }catch(e){ console.error('failed to open targetUrl',e); }
    }

    // ----- request the next ad to be pre‚Äëloaded (defensive) -----
    try{
      if(hasAndroidBridge()){
        if(typeof Android.preloadRewardedAd === 'function'){
          Android.preloadRewardedAd();
        }else if(Android.preloadRewardedAd){
          Android.preloadRewardedAd();
        }
      }
    }catch(e){ console.warn('preload after ad failed',e); }
  },1000);
};

/* --------------------------- INIT --------------------------- */
(async ()=>{
  await sendStoredToBackend();
  await loadVideos();

  // ask native to preload a rewarded ad for the first use (if bridge exists)
  try{
    if(hasAndroidBridge()){
      if(typeof Android.preloadRewardedAd === 'function'){
        Android.preloadRewardedAd();
      }else if(Android.preloadRewardedAd){
        Android.preloadRewardedAd();
      }
      console.log('Requested native to preload rewarded ad (init).');
    }else{
      console.log('Android bridge not detected on init (likely running in browser).');
    }
  }catch(e){
    console.warn('preload request failed',e);
  }
})();
</script>

</body>
</html>
