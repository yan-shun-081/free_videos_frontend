<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Inline Video Queue</title>

<style>
:root{
  --bg:#0f1724;
  --card:#0b1220;
  --muted:#9aa6b2;
  --accent:#06b6d4;
  --soft:#e6eef5;
}
*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
  background:linear-gradient(180deg,#071025 0%, #071827 100%);
  color:var(--soft);
  font-family:Arial, Helvetica, sans-serif;
}
body{
  padding:16px;
  overflow-x:hidden;
}

/* Queue Container */
.queue{
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow-y:auto;
  max-height:100vh;
}

/* Item Card */
.queue-item{
  background:rgba(255,255,255,0.05);
  border-radius:10px;
  padding:10px;
  cursor:pointer;
  transition:0.15s, opacity 0.3s ease-in;
  opacity:0;
}
.queue-item.visible{opacity:1;}
.queue-item.active{
  border:1px solid var(--accent);
  box-shadow:0 6px 20px rgba(6,182,212,0.3);
}

/* Thumbnail */
.thumb{
  width:100%;
  aspect-ratio:16/9;
  border-radius:8px;
  background:#000;
  overflow:hidden;
  background-size:cover;
  background-position:center;
}

/* Metadata */
.q-title{font-size:15px;font-weight:600;margin:6px 0 2px}
.q-sub{font-size:12px;color:var(--muted)}
.q-id{font-size:11px;color:var(--muted)}
.q-link{font-size:12px;color:var(--soft); margin-top:4px}
.q-link a{color:#4ecbff;text-decoration:none;}
.q-link a:hover{text-decoration:underline;}

/* Controls */
.controls{
  display:flex;
  justify-content:center;
  gap:12px;
  padding:14px 0;
  position:sticky;
  bottom:10px;
}
.btn{
  padding:8px 14px;
  border-radius:8px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.2);
  color:var(--soft);
  cursor:pointer;
  font-size:14px;
}
.btn:hover{
  background:var(--accent);
  color:#000;
}

/* Loader */
.loader{
  text-align:center;
  padding:20px;
  color:var(--muted);
  font-size:14px;
}
</style>
</head>

<body>

<div class="queue" id="queueList">
  <div class="loader" id="loader">Loading videos...</div>
</div>

<div class="controls">
  <button class="btn" id="prevBtn">Prev</button>
  <button class="btn" id="nextBtn">Next</button>
</div>

<script>
const BACKEND = 'https://free_videos_displaying_backend.ajaia-backend.workers.dev';
const STORAGE_KEY = 'clicked_ids';

const queueList = document.getElementById('queueList');
const loader = document.getElementById('loader');
let videos = [];            
let displayedCount = 0;     
const BATCH_SIZE = 30;      
let currentIndex = 0;

// Ad timing intervals in seconds: 10s, 2min, 5min, 10min, 20min, 30min, 40min, 50min, 60min...
const AD_INTERVALS = [10, 120, 300, 600, 1200, 1800, 2400, 3000, 3600, 4200, 4800, 5400, 6000, 6600, 7200];

/* ---------- LocalStorage helpers ---------- */
function getStoredIds(){
  try{
    const stored = localStorage.getItem(STORAGE_KEY);
    return stored ? JSON.parse(stored) : [];
  }catch{return [];}
}
function store(id){
  const ids = new Set(getStoredIds());
  ids.add(id);
  localStorage.setItem(STORAGE_KEY, JSON.stringify([...ids]));
}
function clearStored(){ localStorage.removeItem(STORAGE_KEY); }

/* ---------- Send stored clicks to backend ---------- */
async function sendStoredToBackend(){
  const ids = getStoredIds();
  if(ids.length===0) return;
  try{
    await fetch(`${BACKEND}/clicked_videos`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({video_ids:ids})
    });
    console.log('Sent to backend:',ids);
    clearStored();
  }catch(err){
    console.error('Failed to send ids:',err);
  }
}

/* ---------- Load all videos once ---------- */
async function loadVideos(){
  loader.textContent = "Fetching videos...";
  try{
    const res = await fetch(BACKEND);
    videos = await res.json();
    loader.remove();
    renderNextBatch(); 
  }catch{
    loader.textContent = "âŒ Failed to load videos from backend";
  }
}

/* ---------- Check if ads should be played for this video ---------- */
function shouldPlayAds(videoData){
  // If phone_number is NULL, undefined, empty string, or "null"/"NULL" string - don't play ads
  const phoneNumber = videoData.phone_number;
  if(phoneNumber === null || phoneNumber === undefined || phoneNumber === '' || phoneNumber === 'null' || phoneNumber === 'NULL'){
    return false;
  }
  return true;
}

/* ---------- Render next 30 videos ---------- */
function renderNextBatch(){
  const nextBatch = videos.slice(displayedCount, displayedCount + BATCH_SIZE);
  displayedCount += nextBatch.length;

  nextBatch.forEach((v,i)=>{
    const card = document.createElement('div');
    card.className = 'queue-item';
    const absoluteIndex = (displayedCount - nextBatch.length) + i;
    
    // phone_number is stored in dataset but NOT displayed
    card.dataset.phoneNumber = v.phone_number || '';
    
    card.innerHTML = `
      <div class="thumb" style="background-image:url('${v.archive_org_iframe_image_link||""}')"></div>
      <div class="q-title">${v.title || "Untitled"}</div>
      <div class="q-sub">By ${v.username || "Unknown"}</div>
      <div class="q-id">ID: ${v.id || "?"}</div>

      <!-- CLICKABLE LINKS -->
      <div class="q-link">Link 1: <a href="${v.link_1}" target="_blank">${v.link_1 || "No link"}</a></div>
      <div class="q-link">Link 2: <a href="${v.link_2}" target="_blank">${v.link_2 || "No link"}</a></div>
    `;
    card.onclick = () => playInline(absoluteIndex);
    queueList.appendChild(card);
    requestAnimationFrame(()=>card.classList.add('visible'));
  });

  if(displayedCount >= videos.length){
    const endMsg = document.createElement('div');
    endMsg.className = 'loader';
    endMsg.textContent = "ðŸŽ‰ All videos loaded";
    queueList.appendChild(endMsg);
  }
}

/* ---------- Scroll listener ---------- */
queueList.addEventListener('scroll',()=>{
  const bottomReached = queueList.scrollTop + queueList.clientHeight >= queueList.scrollHeight - 150;
  if(bottomReached && displayedCount < videos.length){
    renderNextBatch();
  }
});

/* ---------- Helper: detect Android bridge ---------- */
function hasAndroidBridge(){
  return (typeof Android !== 'undefined' && Android !== null);
}

/* ---------- Global callbacks expected to be called by native -----------------
   Your WebAppInterface will call these JS functions:
     - onAdPreloaded()           // ad cached and ready
     - onAdFailedToPreload()     // preload failed
     - onAdNotAvailable()        // no ad to show right now
     - onAdCompleted(targetUrl)  // user watched the rewarded ad (native passes targetUrl)
   --------------------------------------------------------------------------- */

window.onAdPreloaded = function(){
  console.log('onAdPreloaded()');
};

window.onAdFailedToPreload = function(){
  console.warn('onAdFailedToPreload()');
};

window.onAdNotAvailable = function(){
  console.warn('onAdNotAvailable() â€” resuming video (no web fallback).');
  // Resume paused video if native reported no ad
  try{
    const active = document.querySelector('.queue-item.active');
    if(active){
      const v = active.querySelector('video');
      if(v && v._wasPausedForAd){
        v._wasPausedForAd = false;
        v.play().catch(()=>{});
      }
    }
  }catch(e){ console.error(e); }
};

window.onAdCompleted = function(targetUrl){
  console.log('onAdCompleted() ->', targetUrl);

  try{
    const active = document.querySelector('.queue-item.active');
    if(active){
      const v = active.querySelector('video');
      if(v && v._wasPausedForAd){
        v._wasPausedForAd = false;
        v.play().catch(()=>{});
      }
    }
  }catch(e){ console.error(e); }

  // Request native to preload the next ad (defensive)
  try{
    if(hasAndroidBridge() && typeof Android.preloadRewardedAd === 'function'){
      Android.preloadRewardedAd();
    } else if (hasAndroidBridge() && Android.preloadRewardedAd){
      Android.preloadRewardedAd();
    }
  }catch(e){ console.warn('preload call failed', e); }

  // If native passed a targetUrl, open it inside the WebView using native helper
  try{
    if (targetUrl && targetUrl !== 'null' && targetUrl !== '') {
      if (hasAndroidBridge() && typeof Android.loadUrlInWebView === 'function') {
        Android.loadUrlInWebView(targetUrl);
      } else if (hasAndroidBridge() && Android.loadUrlInWebView) {
        Android.loadUrlInWebView(targetUrl);
      } else {
        // As a graceful fallback (shouldn't happen in-app) open in same window
        window.location.href = targetUrl;
      }
    }
  }catch(e){ console.error('failed to open targetUrl', e); }
};

/* ---------- Play inline video (with ad logic at multiple intervals) ---------- */
function playInline(i){
  currentIndex = i;
  const v = videos[i];
  const items = document.querySelectorAll('.queue-item');

  items.forEach((el,idx)=>{
    el.classList.toggle('active', idx===i);
    const thumb = el.querySelector('.thumb');
    if(idx===i){
      thumb.innerHTML = `
        <video controls controlsList="nodownload" autoplay playsinline
               style="width:100%;height:100%"
               src="${v.mp4_link}" 
               poster="${v.archive_org_iframe_image_link}">
        </video>`;
    }else{
      thumb.innerHTML = '';
      if(videos[idx]) thumb.style.backgroundImage = `url('${videos[idx].archive_org_iframe_image_link}')`;
    }
  });

  queueList.children[i]?.scrollIntoView({behavior:'smooth',block:'center'});
  if(v.id!=null) store(Number(v.id));

  // Check if ads should be played for this video (based on phone_number)
  const adsEnabled = shouldPlayAds(v);
  console.log('Ads enabled for this video:', adsEnabled, '| phone_number:', v.phone_number);

  // Attach timeupdate listener to active video to trigger ad at intervals
  requestAnimationFrame(()=>{
    const active = document.querySelector('.queue-item.active');
    if(!active) return;
    const video = active.querySelector('video');
    if(!video) return;

    // Track which ad intervals have been triggered for this video
    video._triggeredIntervals = new Set();
    video._wasPausedForAd = false;
    video._adsEnabled = adsEnabled;

    // Helper to trigger ad for this video element
    const triggerAdForVideo = (intervalSeconds) => {
      // Skip if ads are disabled for this video (phone_number is NULL)
      if(!video._adsEnabled){
        console.log('Ads disabled for this video (phone_number is NULL), skipping ad at', intervalSeconds, 'seconds');
        return;
      }
      
      if(video._triggeredIntervals.has(intervalSeconds)) return;
      video._triggeredIntervals.add(intervalSeconds);

      console.log('Triggering ad at interval:', intervalSeconds, 'seconds');

      // Pause and mark for resume after ad
      try{
        video._wasPausedForAd = true;
        video.pause();
      }catch(e){ console.warn('Could not pause video', e); }

      // Ask native to show the rewarded ad
      try{
        if(hasAndroidBridge() && typeof Android.requestRewardedAd === 'function'){
          Android.requestRewardedAd(video.currentSrc || video.src || '');
          console.log('Requested rewarded ad from native.');
        } else if (hasAndroidBridge() && Android.requestRewardedAd){
          Android.requestRewardedAd(video.currentSrc || video.src || '');
          console.log('Requested rewarded ad from native (fallback call).');
        } else {
          console.warn('Android bridge not available; no ad will play and video will be resumed.');
          // Resume immediately if native is not available
          video._wasPausedForAd = false;
          video.play().catch(()=>{});
        }
      }catch(e){
        console.error('requestRewardedAd error', e);
        video._wasPausedForAd = false;
        video.play().catch(()=>{});
      }
    };

    function onTimeUpdate(){
      const currentTime = video.currentTime;
      
      // Check each interval and trigger ad when video time passes it
      for(const interval of AD_INTERVALS){
        if(currentTime >= interval && currentTime < interval + 1 && !video._triggeredIntervals.has(interval)){
          triggerAdForVideo(interval);
          break; // Only trigger one ad at a time
        }
      }
    }

    // Remove previous listeners if any
    if(video._timeupdateListener){
      video.removeEventListener('timeupdate', video._timeupdateListener);
    }
    video._timeupdateListener = onTimeUpdate;
    video.addEventListener('timeupdate', video._timeupdateListener);
  });
}

/* ---------- Prev/Next controls ---------- */
prevBtn.onclick = () => {
  if(videos.length>0) playInline((currentIndex-1+videos.length)%videos.length);
};
nextBtn.onclick = () => {
  if(videos.length>0) playInline((currentIndex+1)%videos.length);
};

/* ---------- Init ---------- */
(async ()=>{
  await sendStoredToBackend(); 
  await loadVideos();

  // Request native to preload a rewarded ad when user enters the app (if bridge exists)
  try{
    if(hasAndroidBridge()){
      if(typeof Android.preloadRewardedAd === 'function') Android.preloadRewardedAd();
      else if (Android.preloadRewardedAd) Android.preloadRewardedAd();
      console.log('Requested native to preload rewarded ad (init).');
    } else {
      console.log('Android bridge not detected on init (likely running in browser).');
    }
  }catch(e){
    console.warn('preload request failed', e);
  }
})();
</script>

</body>
</html>
